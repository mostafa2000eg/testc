name: Build and Release Customer Issues Management System

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        # No external dependencies needed - using built-in modules only
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --name "CustomerIssuesManagement" customer_issues_main.py
    
    - name: Create portable package
      run: |
        mkdir portable_package
        if (Test-Path "dist\CustomerIssuesManagement.exe") {
          Copy-Item "dist\CustomerIssuesManagement.exe" "portable_package\"
        }
        Copy-Item "customer_issues_*.py" "portable_package\"
        Copy-Item "*.md" "portable_package\" -ErrorAction SilentlyContinue
        Copy-Item "requirements.txt" "portable_package\" -ErrorAction SilentlyContinue
        Copy-Item "LICENSE.txt" "portable_package\" -ErrorAction SilentlyContinue
        
        # Create run scripts
        '@echo off' | Out-File "portable_package\run.bat" -Encoding UTF8
        'chcp 65001 > nul' | Out-File "portable_package\run.bat" -Append -Encoding UTF8
        'cd /d "%~dp0"' | Out-File "portable_package\run.bat" -Append -Encoding UTF8
        'if exist CustomerIssuesManagement.exe (' | Out-File "portable_package\run.bat" -Append -Encoding UTF8
        '    CustomerIssuesManagement.exe' | Out-File "portable_package\run.bat" -Append -Encoding UTF8
        ') else (' | Out-File "portable_package\run.bat" -Append -Encoding UTF8
        '    python customer_issues_main.py' | Out-File "portable_package\run.bat" -Append -Encoding UTF8
        ')' | Out-File "portable_package\run.bat" -Append -Encoding UTF8
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: portable_package/

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Build Linux executable
      run: |
        pyinstaller --onefile --name "customer-issues-management" customer_issues_main.py
    
    - name: Create portable package
      run: |
        mkdir -p portable_package_linux
        if [ -f "dist/customer-issues-management" ]; then
          cp dist/customer-issues-management portable_package_linux/
          chmod +x portable_package_linux/customer-issues-management
        fi
        cp customer_issues_*.py portable_package_linux/ || true
        cp *.md portable_package_linux/ || true
        cp requirements.txt portable_package_linux/ || true
        cp LICENSE.txt portable_package_linux/ || true
        
        # Create run script
        cat > portable_package_linux/run.sh << 'EOF'
        #!/bin/bash
        cd "$(dirname "$0")"
        if [ -f "./customer-issues-management" ]; then
            ./customer-issues-management
        else
            python3 customer_issues_main.py
        fi
        EOF
        chmod +x portable_package_linux/run.sh
    
    - name: Create tarball
      run: |
        tar -czf customer-issues-management-linux.tar.gz portable_package_linux/
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: customer-issues-management-linux.tar.gz

  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: windows-build/
    
    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: linux-build
        path: linux-build/
    
    - name: Create Windows ZIP
      run: |
        cd windows-build && zip -r ../customer-issues-management-windows.zip .
    
    - name: Get release version
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        release_name: Customer Issues Management System ${{ steps.get_version.outputs.VERSION }}
        body: |
          # ğŸ‰ Customer Issues Management System ${{ steps.get_version.outputs.VERSION }}
          ## Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ${{ steps.get_version.outputs.VERSION }}
          
          ### âœ¨ Key Features / Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:
          - ğŸ¨ **Enhanced UI** with split layout / ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ ØªØ®Ø·ÙŠØ· Ù…Ù‚Ø³Ù…
          - ğŸ” **Advanced Search** with 7 types / Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù… Ø¨Ù€ 7 Ø£Ù†ÙˆØ§Ø¹
          - ğŸ“¨ **Dual Numbering** for correspondence / ØªØ±Ù‚ÙŠÙ… Ù…Ø²Ø¯ÙˆØ¬ Ù„Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª
          - ğŸ“Š **11 Issue Categories** / 11 ØªØµÙ†ÙŠÙ Ù„Ù„Ù…Ø´Ø§ÙƒÙ„
          - ğŸ‘¥ **Staff Management** / Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
          - ğŸ”„ **Auto Backups** / Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
          
          ### ğŸ“¦ Downloads / Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª:
          
          **For Windows / Ù„Ù„ÙˆÙŠÙ†Ø¯ÙˆØ²:**
          - `customer-issues-management-windows.zip` - Portable package / Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
          
          **For Linux / Ù„Ù„ÙŠÙ†ÙƒØ³:**
          - `customer-issues-management-linux.tar.gz` - Linux package / Ø­Ø²Ù…Ø© Ù„ÙŠÙ†ÙƒØ³
          
          ### ğŸš€ Requirements / Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª:
          - **Windows 7+** or **Linux** / ÙˆÙŠÙ†Ø¯ÙˆØ² 7+ Ø£Ùˆ Ù„ÙŠÙ†ÙƒØ³
          - **Python 3.7+** (for source version) / Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ¯Ø±ÙŠØ©
          - **100MB** free space / Ù…Ø³Ø§Ø­Ø© ÙØ§Ø±ØºØ©
          
          ### ğŸ“š Documentation / Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚:
          All documentation is included in the package
          Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ù…Ø±ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ø­Ø²Ù…Ø©
          
          ---
          
          **Developed specifically for gas companies**
          **ØªÙ… ØªØ·ÙˆÙŠØ±Ù‡ Ø®ØµÙŠØµØ§Ù‹ Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ØºØ§Ø²**
        draft: false
        prerelease: false
    
    - name: Upload Windows Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: customer-issues-management-windows.zip
        asset_name: customer-issues-management-windows.zip
        asset_content_type: application/zip
    
    - name: Upload Linux Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: linux-build/customer-issues-management-linux.tar.gz
        asset_name: customer-issues-management-linux.tar.gz
        asset_content_type: application/gzip